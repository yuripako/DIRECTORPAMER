CREATE PROCEDURE `pamervirtual`.`SP_DIRECTOR_CONVER_PROMEDIO`(
	intCiclo int,
	intLinea int,
	varTipo varchar(20)
)
BEGIN
	select s1.codciclo, l1.nomlinea, s1.nomsalones,concat(t1.apellidos,' ',t1.nombres ) as tutor, count(a1.codalumno) as nro_alumn , 
	count(tb.alumno_cod) as nro_conveso,ROUND(sum(COALESCE(tb.acuer, 0))/count(a1.codalumno) ,2) as promedio, ati.grupodes
	from alumnos a1 
	left join datos_basicos db on a1.codalumno = db.codfox 
	left join alumnos_tipopag ati on a1.codtipopag =ati.codtipopag 
	left join salones s1 on s1.codsalones = a1.codsalon 
	left join tutores t1 on t1.codtutor = s1.codtutor 
	left join ccostos cc on cc.codccostos = a1.codccosto and s1.codccosto = cc.codccostos 
	left join lineas l1 on l1.codlinea = cc.codlinea 
	left join (
		select a.codalumno, ao.alumno_cod,cc.codlinea, s.codciclo , s.codsalones,count(ao.acuerdo_id) as acuer
		from alumnos a
		left join acuerdos_orientacion ao on ao.alumno_cod = a.codalumno
		left join salones s on s.codsalones = ao.salon
		left join ccostos cc on cc.codccostos = a.codccosto
		where ao.acuerdo_relacion = 1
		and s.codciclo = intCiclo and cc.codlinea = intLinea
		group by ao.alumno_cod 
	) as tb on tb.codsalones = s1.codsalones and a1.codalumno = tb.alumno_cod
	where s1.codciclo = intCiclo and cc.codlinea = intLinea
	and db.swactivo = 1 and db.sweliminado =0 and a1.swretirado	= 0	and a1.swanulado = 0
	and if(varTipo='TODOS',ati.grupodes!=varTipo, ati.grupodes=varTipo)
	group by s1.codsalones
	order by s1.codsalones, a1.codalumno;
END