CREATE DEFINER=`developer2021`@`%` PROCEDURE `SP_DIRECTOR_ALUMNOS_xxx_VISTA`(
_codciclo INT,
_codlinea INT
)
BEGIN
SELECT
tbl1.codsalones, tbl1.codciclo,tbl1.nomlinea, tbl1.nomsalones,tbl1.datos,tbl1.cantidad,
tbl2.seleccionado,COUNT(IF(ing.ingreso = 's', 1, NULL)) as ingresantes ,met.meta
FROM
(
SELECT
b.codciclo,d.codlinea,d.nomlinea,b.codsalones, b.nomsalones, 
CONCAT(a.apellidos," ",a.nombres) datos,
COUNT(DISTINCT alu.codalumno) cantidad
FROM tutores a
INNER  JOIN salones b on a.codtutor =b.codtutor
INNER JOIN ccostos c on c.codccostos= b.codccosto
INNER JOIN lineas d on d.codlinea=c.codlinea
INNER JOIN alumnos alu on alu.codsalon=b.codsalones
LEFT JOIN  ingesantesdetalle ing on alu.codalumno =ing.codalumno
WHERE alu.codciclo=_codciclo  AND c.codlinea=_codlinea
GROUP BY b.codsalones
)tbl1
LEFT JOIN
(
SELECT b.codsalon , COUNT(a.codalumno) seleccionado
FROM distancia_alumnosseleccionados a
INNER JOIN alumnos b on a.codalumno  = b.codalumno
WHERE a.swseleccionado=_codlinea AND b.codciclo=_codciclo
GROUP BY 1
)tbl2 on  tbl2.codsalon = tbl1.codsalones

LEFT JOIN ingesantesdetalle ing ON tbl1.codsalones = ing.codsalon
LEFT JOIN meta met ON met.codsalon = tbl1.codsalones
-- WHERE ing.ingreso='n'
GROUP BY tbl1.codsalones;

END